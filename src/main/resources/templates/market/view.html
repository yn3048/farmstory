<!DOCTYPE html>
<!-- Default Layout Import-->
<html lang="en"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{/common/layouts/defaultLayout}"
      layout:fragment="Content"
>
<script th:src="@{/js/util.js}"></script>
<script th:inline="javascript">
    window.onload = function (){

        const totalElement = document.getElementById('total');
        const totalValue = parseInt(totalElement.innerText);

        const discountPrice = document.getElementById('discountPrice');
        const discountPricevalue = parseInt(discountPrice.innerText);

        const price = document.getElementById('ProductPrice');
        const priceValue = parseInt(price.innerText);

        console.log('price : ' + price);
        console.log('price : ' + priceValue);

        totalElement.innerText = totalValue;
        priceValue.innerText = priceValue;

        totalElement.innerText = totalValue.toLocaleString() + ' ì›'; // ê²°ê³¼ê°’ì— ì›(â‚©) ì¶”ê°€
        discountPrice.innerText = '-' + discountPricevalue.toLocaleString() + ' ì›'; // ê²°ê³¼ê°’ì— ì›(â‚©) ì¶”ê°€
        priceValue.innerText = totalValue.toLocaleString() + ' ì›';


        //discountPrice.style.color = 'red';
        //totalElement.style.color = 'blue';

        const btnCart = document.getElementById('btnCart');
        const btnOrder = document.getElementById('btnOrder');

        const count = document.getElementById('count');
        const hiddenPrice = document.getElementById('hiddetotal');
        const delprice = document.getElementById('delPrice');
        const totalPrice = document.getElementById('total');

        let countInputObj = count.value;
        console.log('countInputObj..1 :' + countInputObj);

        // ì…ë ¥ ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°’ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ JavaScript ê°ì²´ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        count.addEventListener('input', function() {
            // ë³€ê²½ëœ ê°’ì„ JavaScript ê°ì²´ì— ë°˜ì˜í•©ë‹ˆë‹¤.
            countInputObj = parseInt(count.value);

            // ë³€ê²½ëœ ê°ì²´ë¥¼ ì½˜ì†”ì— ì¶œë ¥í•©ë‹ˆë‹¤.
            console.log('countInputObj..2 :' + countInputObj);
        });

        const countValue = count.value;
        console.log('countValue : '+countValue);

        /*
            êµ¬ë§¤ ìˆ˜ëŸ‰ ìˆ˜ì • ì‹œ í•©ê³„ ì •ë³´ ê°±ì‹ 
         */
        count.onchange = function () {

            const price = parseInt(hiddenPrice.innerText);
            const quantity = parseInt(count.value);
            console.log('quantity : ' + quantity);

            // ë°°ì†¡ë¹„
            let delprice2 = parseInt(delprice.innerText);

            console.log('discountPrice : ' + discountPrice);

            // ì´ í• ì¸ëœ ê°€ê²© = í• ì¸ê°€ê²© * ë¬¼í’ˆ ìˆ˜
            let discountPriceSum = -(discountPricevalue * quantity);
            console.log('discountPriceSum : ' + discountPriceSum);

            let total = (price * quantity) + delprice2 - discountPriceSum;// í• ì¸ í›„ ì´ì•¡

            if (total >= 30000) {
                delprice2 = 0;
                document.getElementById('freeDel').style.display = 'block';
                document.getElementById('delPrice').style.display = 'none';
                document.getElementById('freeDelText').style.display = 'none';
            }else {
                document.getElementById('freeDel').style.display = 'none';
                document.getElementById('delPrice').style.display = 'block';
                document.getElementById('freeDelText').style.display = 'block';
            }

            // ë°°ì†¡ë¹„ í¬í•¨í•˜ì—¬ ìµœì¢… ì´ì•¡ ì¬ê³„ì‚°
            total = (price * quantity) + delprice2 - discountPriceSum + 'ì›';

            totalPrice.innerText = total.toString();

            discountPrice.innerText = discountPriceSum.toString() + 'ì›';


        }


        /*
            ì¥ë°”êµ¬ë‹ˆ í´ë¦­ ì‹œ êµ¬ë§¤ìˆ˜ëŸ‰ ê°’ì„ getìœ¼ë¡œ í¬í•¨ì‹œì¼œ ì „ì†¡
         */

        const sendForm = document.getElementById('sendForm');

        if(btnCart){
            btnCart.onclick = async function (e){
                e.preventDefault();

                if(confirm("ì¥ë°”êµ¬ë‹ˆì— ë‹´ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    const jsonData = {
                        "pno": sendForm.pno.value,
                        "pcount": sendForm.pcount.value
                    }
                    console.log(jsonData);

                    const data = await fetchPost(`/farmstory/cart/insert`,jsonData);
                    console.log(data);
                    if(data != null){
                        if(confirm("ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
                            sendForm.submit();
                        }
                    }else{
                        alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                    return false;
                }else{

                    return false;
                }
            }
        }

        if(btnOrder){
            btnOrder.onclick = async function (e){
                e.preventDefault();
                const jsonData = {
                    "pno": sendForm.pno.value,
                    "pcount": sendForm.pcount.value
                }
                console.log(jsonData);

                const data = await fetchPost(`/farmstory/cart/insert`,jsonData);
                console.log("data : " + data);
                if(data != null){
                    sendForm.action = "/farmstory/market/order";
                    sendForm.submit();

                }else{
                    alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                return false;
            }
        }

    }
</script>

<head>
    <meta charset="UTF-8">
    <title>íŒœìŠ¤í† ë¦¬::ì¥ë³´ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <link rel="stylesheet" th:href="@{/css/style2.css}"/>
</head>

<div id="sub">
    <div><img th:src="@{/images/sub_top_tit2.png}" alt="MARKET"></div>
    <section class="market">
        <aside>
            <img th:src="@{/images/sub_aside_cate2_tit.png}" alt="ì¥ë³´ê¸°"/>

            <ul class="lnb">
                <li class="on"><a th:href="@{/market/list}">ì¥ë³´ê¸°</a></li>
            </ul>
        </aside>
        <article class="view">
            <nav>
                <img th:src="@{/images/sub_nav_tit_cate2_tit1.png}" alt="ì¥ë³´ê¸°"/>
                <p>
                    HOME > ì¥ë³´ê¸° > <em>ì¥ë³´ê¸°</em>
                </p>
            </nav>

            <!-- ë‚´ìš© ì‹œì‘ -->

            <h3>ê¸°ë³¸ì •ë³´</h3>
            <div class="basic">

                <form th:action="@{/market/cart}" id="sendForm" method="post">
                    <img th:src="@{|/product/${productDTO.cate}/${productDTO.img1}|}" alt="ë”¸ê¸° 500g">
                    <table border="0">

                        <tr>
                            <td>ìƒí’ˆëª…</td>
                            <td class="prodName">[[${productDTO.pname}]]</td>
                        </tr>
                        <tr>
                            <td hidden="">ìƒí’ˆì½”ë“œ</td>
                            <td hidden="">[[${productDTO.pno}]]</td>
                            <td>
                                <input type="hidden" name="pno" th:value="${productDTO.pno}">

                            </td>
                        </tr>
                        <tr>
                            <td>ë°°ì†¡ë¹„</td>
                            <td>
                                <span id="delPrice">[[${productDTO.delprice}]]ì›</span>
                                <span id="freeDel" style="display: none; color: tomato; font-weight: bold;">ğŸ˜†ë¬´ë£Œ ë°°ì†¡</span>
                                <em id="freeDelText">3ë§Œì› ì´ìƒ ë¬´ë£Œë°°ì†¡</em>
                            </td>
                        </tr>
                        <tr>
                            <td>íŒë§¤ê°€ê²©</td>
                            <td class="ProductPrice" id="ProductPrice" th:text="${productDTO.price}"></td>
                        </tr>
                        <tr>
                            <td>êµ¬ë§¤ìˆ˜ëŸ‰</td>
                            <td>
                                <input type="number" name="pcount" id="count"  value="1" min="1">
                            </td>
                        </tr>
                        <tr>
                            <td>í• ì¸ìœ¨</td>
                            <td class="discount1">[[${productDTO.discount}]]%</td>
                        </tr>
                        <tr>
                            <td>í• ì¸ê¸ˆì•¡</td>
                            <td class="discountPrice discount2" id="discountPrice" th:text="(${productDTO.price} * (${productDTO.discount} / 100)) + 'ì›'"></td>
                            <td class="hiddeDiscountPrice" id="hiddeDiscountPrice" th:text="(${productDTO.price} * (${productDTO.discount} / 100))" hidden></td>
                        </tr>
                        <tr>
                            <td>í•©ê³„</td>
                            <td class="total" id="total" th:text="${productDTO.delprice} + (${productDTO.price} - (${productDTO.price} * (${productDTO.discount} / 100))) + 'ì›'"></td>
                            <td class="hiddetotal" id="hiddetotal" th:text="(${productDTO.price} - ${productDTO.price} * (${productDTO.discount} / 100))" hidden></td>
                        </tr>
                    </table>
                </form>

                <div class="viewBtn" style="float: right; margin-top: 10px;">
                    <a sec:authorize="isAuthenticated()" th:href="@{/market/cart(pno=${productDTO.pno})}" id="btnCart" class="btn btnCart">ì¥ë°”êµ¬ë‹ˆ</a>
                    <a sec:authorize="isAuthenticated()" th:href="@{/market/order(pno=${productDTO.pno})}" id="btnOrder" class="btn btnOrder">ë°”ë¡œêµ¬ë§¤</a>
                </div>

            </div>

            <h3>ìƒí’ˆì„¤ëª…</h3>
            <div class="detail">
                <img th:src="@{|/product/${productDTO.cate}/${productDTO.img3}|}" alt="">

            </div>

            <h3>ë°°ì†¡ì •ë³´</h3>
            <div class="delivery">
                <p>
                    ì…ê¸ˆí•˜ì‹  ì´í›„ íƒë°°ì†¡ì¥ë²ˆí˜¸ëŠ” SMS(ë¬¸ìì„œë¹„ìŠ¤)ë¥¼ í†µí•´ ê³ ê°ë‹˜ê»˜ ì•ˆë‚´í•´ë“œë¦½ë‹ˆë‹¤.
                </p>
            </div>

            <h3>êµí™˜/ë°˜í’ˆ</h3>
            <div class="exchange">
                <table border="0">
                    <tr>
                        <td>êµí™˜ ë°˜í’ˆì´ ê°€ëŠ¥í•œ ê²½ìš°</td>
                        <td>
                            <ul>
                                <li>íŒœìŠ¤í† ë¦¬ ìƒí’ˆì— í•˜ìê°€ ìˆê±°ë‚˜ ë¶ˆëŸ‰ì¸ ê²½ìš°</li>
                                <li>ì±„ì†Œ, ê³¼ì¼, ì–‘ê³¡ë“±ì˜ ì‹í’ˆì€ ë§Œ1ì¼ ì´ë‚´</li>
                                <li>ê¸°íƒ€ ìƒí’ˆì€ ìˆ˜ë ¹ì¼ë¡œë¶€í„° ì˜ì—…ì¼ ê¸°ì¤€ ì¼ì£¼ì¼ ì´ë‚´</li>
                                <li>ë°›ìœ¼ì‹  ìƒí’ˆì´ í‘œì‹œì‚¬í•­ê³¼ ë‹¤ë¥¸ ê²½ìš°ì—ëŠ” ë°›ìœ¼ì‹  ë‚ ë¡œë¶€í„° ì¼ì£¼ì¼ ì´ë‚´</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td>êµí™˜ ë°˜í’ˆì´ ë¶ˆê°€ëŠ¥í•œ ê²½ìš°</td>
                        <td>
                            <ul>
                                <li>ì‹ ì„  ì‹í’ˆì˜ ê²½ìš° ë‹¨ìˆœíˆ ë§ˆìŒì— ë“¤ì§€ ì•ŠëŠ” ê²½ìš°</li>
                                <li>ë‹¨ìˆœ ë³€ì‹¬ìœ¼ë¡œ ìƒí’ˆì´ ê°€ì¹˜ê°€ í›¼ì†ë¼ì„œ íŒë§¤ê°€ ì–´ë ¤ìš´ ê²½ìš°</li>
                            </ul>
                        </td>
                    </tr>

                </table>
            </div>
            <a href="#" id="top">
                <img th:src="@{/images/green-top-60.png}"  alt="topBtn">
            </a>
            <!-- ë‚´ìš© ë -->
        </article>
    </section>

</div>

</html>