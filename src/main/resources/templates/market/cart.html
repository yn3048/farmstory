
<!DOCTYPE html>
<!-- Default Layout Import-->
<html lang="en"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/common/layouts/defaultLayout}"
      layout:fragment="Content"
>
<head>
    <meta charset="UTF-8">
    <title>íŒœìŠ¤í† ë¦¬::ì¥ë°”êµ¬ë‹ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{../css/style.css}"/>
    <link rel="stylesheet" th:href="@{../css/style2.css}"/>

    <style>
        #sub > .market > .cart > form> table {
            width: 100%;
            border-collapse: collapse;
            border-bottom: 1px solid #111;
            margin-top: 10px;
        }

        #sub > .market > .cart > form > table tr {border-bottom: 1px solid #eee;}

        #sub > .market > .cart > form > table tr > th {
            padding: 6px;
            background-color:  #A8D031;
            color: #fff;
            text-align: center;
        }


        #sub > .market > .cart > form > table tr > td:last-child {
            font-weight: bold;
            color: #222;
        }

        #sub > .market > .cart > form > table tr > td > a > img.thumb{
            max-width: 100px;
            max-height: 100px;
        }

        #sub > .market > .cart > form > input[name=delCart] {
            margin-top: 20px;
            padding: 6px;
            width: 80px;
            border: none;
            border-radius: 5px;
            background-color: #ff412d;
            color: white;
            cursor: pointer;
        }

        #sub > .market > .cart > .info > form {
            float: right;
            width: 100%;
            position: relative;
            overflow: hidden;
            padding: 6px;
            box-sizing: border-box;
        }

        #sub > .market > .cart > .info > form > table {
            float: right;
            width: 100%;
            margin-left: 16px;
            border-top: 1px solid #111;
            border-bottom: 1px solid #111;
        }

        #sub > .market > .cart > .info > form > table caption {padding: 6px;}

        #sub > .market > .cart > .info > form > table th {
            text-align: left;
            padding: 5px 5px 5px;
            line-height: 26px;
            box-sizing: border-box;
            font-weight: normal;
        }
        #sub > .market > .cart > form > table tr > td.discount {color: #fd5900; font-weight: bold;}

        #sub > .market > .cart > .info > form > table tr {padding: 5px 0;}
        #sub > .market > .cart > .info > form > table tr td {text-align: left;}
        #sub > .market > .cart > .info > form > table tr td.delivery {color: #3754ff; font-weight: bold;}
        #sub > .market > .cart > .info > form > table tr td.total { font-weight: bold; color: #222222; font-size: 17px;}
        #sub > .market > .cart > .info > form > table tr td.discount {font-weight: bold; color:#fd5900;}
        #sub > .market > .cart > .info > form > .btnOrder {
            clear: both;
            float: right;
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #ff412d;
            color: white;
            cursor: pointer;
        }

        #sub #sendForm2 caption {
            text-align: center;
            font-size: 20px;
            caption-side: top;
            color: #111;
            margin-bottom: 5px;
        }

    </style>
</head>
<script th:src="@{/js/util.js}"></script>
<script>

    window.onload = function (){

        const delCart = document.getElementById('delCart');
        const sumAll = document.getElementsByClassName('sumAll');

        const checkboxes = document.getElementsByName('pno');
        const selectAll = document.getElementsByName('selectAll')[0];

        // ğŸˆìƒí’ˆ ì „ì²´ ì„ íƒ
        selectAll.addEventListener('change', function () {

            for (let i = 0; i < checkboxes.length; i++) {
               checkboxes[i].checked = selectAll.checked;
                console.log("ì „ì²´ì„ íƒ");
                sumAllList();
            }
        });

        // ğŸˆ ì²´í¬ëœ ìƒí’ˆ
        for (let i = 0; i < checkboxes.length; i++){
            checkboxes[i].addEventListener('change',function (e){
                console.log("ì„ íƒëœ ìƒí’ˆ");
                sumAllList();
            });
        }

        // ğŸˆì „ì²´í•©ê³„ ê³„ì‚°
        function sumAllList (){

            const selectedItems = document.querySelectorAll("input[name='pno']:checked");
            let totalItems = 0;
            let totalAmount = 0;
            let totalDiscount = 0;
            let totalDeliveryFee = 0;
            let totalPoint = 0;

            selectedItems.forEach(item => {
                const row = item.closest("tr");
                console.log(row.querySelector(".count"));
                const count = parseInt(row.querySelector(".count").textContent); // ìƒí’ˆ ìˆ˜ëŸ‰
                console.log(count);

                const price = parseFloat(row.querySelector(".price").textContent.replace('ì›', '')); // ìƒí’ˆ ê°€ê²©
                const discount = parseFloat(row.querySelector(".discount").textContent.replace('%', '')); // í• ì¸ìœ¨
                const deliveryFee = parseInt(row.querySelector(".delivery").textContent.replace('ì›', '')) // ë°°ì†¡ë¹„

                totalItems += count; // ìƒí’ˆ ìˆ˜ëŸ‰ ëˆ„ì 
                totalAmount += price * count; // ìƒí’ˆ ê¸ˆì•¡ ëˆ„ì 
                totalDiscount += discount * count * 100; // í• ì¸ ê¸ˆì•¡ ëˆ„ì 
                totalDeliveryFee += deliveryFee * count // ë°°ì†¡ë¹„ ëˆ„ì 
                totalPoint += parseInt(row.querySelector(".point").textContent.replace('p', '')) * count // ì ë¦½ í¬ì¸íŠ¸ ëˆ„ì 
                console.log("selectItems..1");
            });

            // ë°°ì†¡ë¹„ ê³„ì‚°
            let comment
            if(totalAmount >= 30000) {
                totalDeliveryFee = 0;
                comment = "3ë§Œì› ì´ìƒ ë¬´ë£Œë°°ì†¡"

            } else {
                comment = totalDeliveryFee + "ì›";
            }

            // ì „ì²´ ì£¼ë¬¸ ê¸ˆì•¡ ê³„ì‚°
            const totalOrderAmount = totalAmount + totalDeliveryFee - totalDiscount ;
            console.log("sumAll..1 : " + totalOrderAmount);

            // ì „ì²´ í•©ê³„ ì¶œë ¥
            sumAll[0].textContent = totalItems; // ìƒí’ˆìˆ˜
            sumAll[1].textContent = totalAmount.toLocaleString() + 'ì›'; // ìƒí’ˆê¸ˆì•¡
            sumAll[2].textContent = totalDiscount.toLocaleString() + 'ì›';  // í• ì¸ê¸ˆì•¡
            sumAll[3].textContent = totalDeliveryFee.innerText = comment; //   ë°°ì†¡ë¹„
            sumAll[4].textContent = totalPoint.toLocaleString() + 'p';  // ì ë¦½ í¬ì¸íŠ¸
            sumAll[5].textContent = totalOrderAmount.toLocaleString() + 'ì›';  // ì „ì²´ ì£¼ë¬¸ê¸ˆì•¡

            console.log('sumALl : ' + sumAll);

        }

         sumAllList();

      //  selectAllCheckbox.addEventListener('change', sumAllList);


        /* ğŸˆìƒí’ˆ ì‚­ì œ */
        delCart.onclick = async function (e) {
            const checkBoxes = document.querySelectorAll("input[name='pno']:checked");
            e.preventDefault();
            if(checkBoxes.length === 0) {
                alert('ì‚­ì œí•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.')
                return false;
            }

            if (confirm("ì •ë§ ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const formData = new FormData(); // FormData ê°ì²´ ìƒì„±


                checkBoxes.forEach(function (checkbox) {
                    formData.append("pno", checkbox.value); // ì„ íƒëœ ì²´í¬ë°•ìŠ¤ì˜ ê°’ì„ FormDataì— ì¶”ê°€
                });

                console.log([...formData]); // FormData ë‚´ìš© í™•ì¸

                const response = await fetch('/farmstory/market/cart/delete', {
                    method: 'POST',
                    body: formData // FormDataë¥¼ ì „ì†¡ ë°ì´í„°ë¡œ ì‚¬ìš©
                });

                const data = await response.json();
                console.log(data);

                if (data != null) {
                    alert("ì‚­ì œ ì™„ë£Œ!");
                    location.reload(true);

                } else {
                    alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                return false;
            } else {
                return false;
            }

        }

    }

</script>


<div id="sub">
    <div><img th:src="@{../images/sub_top_tit2.png}" alt="MARKET"></div>
    <section class="market">
        <aside>
            <img th:src="@{../images/sub_aside_cate2_tit.png}" alt="ì¥ë³´ê¸°"/>

            <ul class="lnb">
                <li class="on"><a th:href="@{/market/list}">ì¥ë³´ê¸°</a></li>
            </ul>
        </aside>
        <article class="cart">
            <nav>
                <img th:src="@{../images/sub_nav_tit_cate2_tit1.png}" alt="ì¥ë³´ê¸°"/>
                <p>
                    HOME > ì¥ë³´ê¸° > <em>ì¥ë³´ê¸°</em>
                </p>
            </nav>

            <!-- ë‚´ìš© ì‹œì‘ -->
            <p class="sort">
                <a th:href="@{#}" class="on">ì¥ë°”êµ¬ë‹ˆ ì „ì²´</a>
            </p>
                <form id="sendForm1"  th:action="@{/market/cart/delete}" method="post">
                <table border="0">
                    <thead>
                    <tr>
                        <th>
                            <input type="checkbox"  id="selectAll" name="selectAll" checked>
                        </th>
                        <th>ì´ë¯¸ì§€</th>
                        <th>ì¢…ë¥˜</th>
                        <th>ìƒí’ˆëª…</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>í• ì¸</th>
                        <th>í¬ì¸íŠ¸</th>
                        <th>ê°€ê²©</th>
                        <th>ì†Œê³„</th>
                    </tr>
                    </thead>
                    <tbody id="prodList">
                    <tr class="empty">
                        <td colspan="9"  th:if="${cartDTOList == null or cartDTOList.isEmpty()}" class="emptyCart">
                            <img th:src="@{/images/head_cart.gif}" alt=""> &nbsp;ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>

                    <tr th:each="cartDTO:${cartDTOList}">
                        <td>
                            <input type="checkbox" checked  name="pno"  th:value="${cartDTO.pno}">
                        </td>
                        <td>
                            <a th:href="@{#}"><img th:src="@{|/product/${cartDTO.cate}/${cartDTO.img1}|}" class="thumb" alt="ì‚¬ê³¼ 500g"></a>
                        </td>
                        <td th:text="${cartDTO.cate}"></td>
                        <td th:text="${cartDTO.pname}"><a th:href="@{#}"></a></td>
                        <td class="count" th:text="${cartDTO.pcount}"></td>
                        <td class="discount" th:text="${cartDTO.discount} + '%'"></td>
                        <td class="point" th:text="${cartDTO.point} + 'p'"></td>
                        <td class="price" th:text="${cartDTO.price} + 'ì›'"></td>
                        <td hidden class="delivery" th:text="${cartDTO.delprice} + 'ì›'"></td>
                        <td th:text="${cartDTO.price - (cartDTO.price * cartDTO.discount / 100)} + 'ì›'" class="sumPrice"></td>
                    </tr>
                    </tbody>
                </table>
                <input type="submit" id="delCart" name="delCart" value="ì„ íƒì‚­ì œ">
                </form>



            <div class="info sumALl">
                <form id="sendForm2" th:action="@{/market/order}">
                        <table border="0">
                            <caption>ì „ì²´í•©ê³„</caption>
                            <tr>
                                <th>ìƒí’ˆìˆ˜</th>
                                <td class="sumAll count">0</td>
                            </tr>
                            <tr>
                                <th>ìƒí’ˆê¸ˆì•¡</th>
                                <td class="sumAll price">0ì›</td>
                            </tr>
                            <tr>
                                <th>í• ì¸ê¸ˆì•¡</th>
                                <td class="sumAll discount">0ì›</td>
                            </tr>
                            <tr>
                                <th>ë°°ì†¡ë¹„</th>
                                <td class="sumAll delivery">0ì›</td>
                            </tr>
                            <tr>
                                <th>ì ë¦½ í¬ì¸íŠ¸</th>
                                <td class="sumAll point">0p</td>
                            </tr>
                            <tr>
                                <th>ì „ì²´ì£¼ë¬¸ê¸ˆì•¡</th>
                                <td class="sumAll total">0ì›</td>
                            </tr>
                        </table>

                    <input type="submit" class="btnOrder" value="ì£¼ë¬¸í•˜ê¸°">
                </form>
            </div>
            <!-- ë‚´ìš© ë -->
            <a href="#" id="top">
                <img th:src="@{/images/green-top-60.png}"  alt="topBtn">
            </a>
        </article>
    </section>

</div>


</html>